<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carga EV</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background: #f2f2f7;
    margin: 0;
    padding: 16px;
}

.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

h1, h2 {
    text-align: center;
    margin-bottom: 16px;
}

label {
    font-size: 14px;
    font-weight: 600;
    display: block;
    margin-top: 14px;
}

input {
    width: 100%;
    font-size: 18px;
    padding: 12px;
    margin-top: 6px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

button {
    width: 100%;
    margin-top: 18px;
    padding: 14px;
    font-size: 17px;
    font-weight: bold;
    border-radius: 14px;
    border: none;
}

.calcular { background: #007aff; color: white; }
.guardar { background: #34c759; color: white; }
.borrar  { background: #ff3b30; color: white; }

.resultado, .historial {
    margin-top: 20px;
    background: #eef1f6;
    padding: 14px;
    border-radius: 12px;
    line-height: 1.6;
}

.dato {
    font-size: 20px;
    font-weight: bold;
}
</style>
</head>

<body>

<div class="card">

<h1>üîã Calculadora carga EV</h1>

<label>Bater√≠a actual (%)</label>
<input id="actual" type="number" value="70" min="0" max="100">

<label>Bater√≠a objetivo (%)</label>
<input id="objetivo" type="number" value="85" min="0" max="100">

<label>Amperios de carga (A)</label>
<input id="amperios" type="number" value="8" min="1" max="32">

<button class="calcular" onclick="calcular()">Calcular</button>

<div class="resultado" id="resultado"></div>

<button class="guardar" onclick="guardar()">Guardar carga</button>

<h2>üìä Mes actual</h2>
<div class="historial" id="historial"></div>

<button class="borrar" onclick="borrar()">Borrar historial</button>

</div>

<script>
const bateriaKWh = 44;
const voltaje = 230;
const precioKWh = 0.1270 * 1.21; // Octopus Relax + IVA
const consumo = 18; // kWh / 100 km

let ultimaCarga = null;

function calcular() {
    const actual = Number(document.getElementById("actual").value);
    const objetivo = Number(document.getElementById("objetivo").value);
    const amperios = Number(document.getElementById("amperios").value);

    if (objetivo <= actual) {
        resultado.innerHTML = "‚ö†Ô∏è El porcentaje objetivo debe ser mayor que el actual.";
        return;
    }

    let energia = 0;
    for (let p = actual; p < objetivo; p++) {
        let factor = 1;
        if (p >= 80 && p < 85) factor = 0.85;
        if (p >= 85) factor = 0.7;
        energia += (bateriaKWh / 100) / factor;
    }

    const potencia = (voltaje * amperios) / 1000;
    const horas = energia / potencia;
    const coste = energia * precioKWh;

    const km = (energia / consumo) * 100;
    const costeKm = coste / km;
    const coste100 = costeKm * 100;

    ultimaCarga = { energia, coste, km };

    const fin = new Date(Date.now() + horas * 3600000);
    const horaFin = fin.toLocaleTimeString("es-ES", {
        hour: "2-digit",
        minute: "2-digit"
    });

    resultado.innerHTML = `
        ‚è± <span class="dato">${horas.toFixed(2)} h</span><br>
        ‚ö° <span class="dato">${energia.toFixed(2)} kWh</span><br>
        üöó <span class="dato">${km.toFixed(1)} km cargados</span><br>
        üí∂ <span class="dato">${coste.toFixed(2)} ‚Ç¨</span><br>
        üìâ <span class="dato">${costeKm.toFixed(3)} ‚Ç¨/km</span><br>
        üìä <span class="dato">${coste100.toFixed(2)} ‚Ç¨/100 km</span><br>
        üïí <span class="dato">${horaFin}</span>
    `;
}

function guardar() {
    if (!ultimaCarga) return;

    const data = JSON.parse(localStorage.getItem("cargas") || "[]");

    data.push({
        fecha: new Date().toISOString(),
        energia: ultimaCarga.energia,
        coste: ultimaCarga.coste,
        km: ultimaCarga.km
    });

    localStorage.setItem("cargas", JSON.stringify(data));
    mostrar();
}

function mostrar() {
    const data = JSON.parse(localStorage.getItem("cargas") || "[]");
    const ahora = new Date();

    let totalCoste = 0;
    let totalKm = 0;

    const mes = data.filter(c => {
        const f = new Date(c.fecha);
        return f.getMonth() === ahora.getMonth() &&
               f.getFullYear() === ahora.getFullYear();
    });

    let html = "";

    mes.forEach(c => {
        totalCoste += c.coste;
        totalKm += c.km;
        html += `‚Ä¢ ${new Date(c.fecha).toLocaleDateString()} ‚Üí ${c.km.toFixed(1)} km / ${c.coste.toFixed(2)} ‚Ç¨<br>`;
    });

    const coste100 = totalKm ? (totalCoste / totalKm) * 100 : 0;

    html += `<br><b>Total mes:</b><br>
             üöó ${totalKm.toFixed(0)} km<br>
             üí∂ ${totalCoste.toFixed(2)} ‚Ç¨<br>
             üìä ${coste100.toFixed(2)} ‚Ç¨/100 km`;

    historial.innerHTML = html || "Sin registros";
}

function borrar() {
    if (confirm("¬øBorrar todo el historial?")) {
        localStorage.removeItem("cargas");
        mostrar();
    }
}

mostrar();
</script>

</body>
</html>