<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Carga EV Pro</title>

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial;
    background: #f2f2f7;
    margin: 0;
    padding: 16px;
}

.card {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

h1, h2 {
    text-align: center;
    margin-bottom: 16px;
}

label {
    font-size: 14px;
    font-weight: 600;
    display: block;
    margin-top: 14px;
}

input, input[type="file"] {
    width: 100%;
    font-size: 18px;
    padding: 12px;
    margin-top: 6px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

button {
    width: 100%;
    margin-top: 14px;
    padding: 14px;
    font-size: 17px;
    font-weight: bold;
    border-radius: 14px;
    border: none;
}

.calcular { background: #007aff; color: white; }
.guardar { background: #34c759; color: white; }
.borrar  { background: #ff3b30; color: white; }
.exportar { background: #ff9500; color: white; }
.importar { background: #5856d6; color: white; }

.resultado, .historial {
    margin-top: 20px;
    background: #eef1f6;
    padding: 14px;
    border-radius: 12px;
    line-height: 1.6;
}

canvas {
    margin-top: 20px;
    border-radius: 12px;
    background: #fff;
}
</style>
</head>
<body>

<div class="card">

<h1>üîã Calculadora Carga EV Pro</h1>

<label>Bater√≠a actual (%)</label>
<input id="actual" type="number" value="70" min="0" max="100">

<label>Bater√≠a objetivo (%)</label>
<input id="objetivo" type="number" value="85" min="0" max="100">

<label>Amperios de carga (A)</label>
<input id="amperios" type="number" value="8" min="1" max="32">

<label>Precio kWh (sin IVA ‚Ç¨)</label>
<input id="precio" type="number" value="0.068" step="0.001">

<label>Km diarios que sueles recorrer (opcional)</label>
<input id="kmdiarios" type="number" value="50">

<button class="calcular" onclick="calcular()">Calcular</button>

<div class="resultado" id="resultado"></div>

<button class="guardar" onclick="guardar()">Guardar carga</button>
<button class="exportar" onclick="exportarCSV()">Exportar historial CSV</button>
<label>Importar historial CSV</label>
<input type="file" id="fileInput" accept=".csv">
<button class="importar" onclick="importarCSV()">Importar CSV</button>

<h2>üìä Mes actual</h2>
<div class="historial" id="historial"></div>

<canvas id="grafico" height="200"></canvas>

<button class="borrar" onclick="borrar()">Borrar historial</button>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const bateriaKWh = 44;
const voltaje = 230;
const iva = 1.21;
const consumo = 18; // kWh / 100 km
let ultimaCarga = null;

function calcular() {
    const actual = Number(document.getElementById("actual").value);
    const objetivo = Number(document.getElementById("objetivo").value);
    const amperios = Number(document.getElementById("amperios").value);
    const precioBase = Number(document.getElementById("precio").value);
    const kmDiarios = Number(document.getElementById("kmdiarios").value) || 0;

    if (objetivo <= actual) {
        resultado.innerHTML = "‚ö†Ô∏è El porcentaje objetivo debe ser mayor que el actual.";
        return;
    }

    const precioKWh = precioBase * iva;

    // Estimaci√≥n kWh
    let energia = 0;
    for (let p = actual; p < objetivo; p++) {
        let factor = 1;
        if (p >= 80 && p < 85) factor = 0.85;
        if (p >= 85) factor = 0.7;
        energia += (bateriaKWh / 100) / factor;
    }

    const potencia = (voltaje * amperios) / 1000;
    const horas = energia / potencia;
    const coste = energia * precioKWh;

    const km = (energia / consumo) * 100;
    const costeKm = coste / km;
    const coste100 = costeKm * 100;

    const bateriaFinal = actual + ((objetivo - actual));

    let diasCubiertos = kmDiarios ? (km / kmDiarios).toFixed(1) : "-";

    ultimaCarga = { energia, coste, km, bateriaFinal };

    const fin = new Date(Date.now() + horas * 3600000);
    const horaFin = fin.toLocaleTimeString("es-ES", {hour:"2-digit",minute:"2-digit"});

    resultado.innerHTML = `
        ‚è± <span class="dato">${horas.toFixed(2)} h</span><br>
        ‚ö° <span class="dato">${energia.toFixed(2)} kWh</span><br>
        üöó <span class="dato">${km.toFixed(1)} km cargados</span><br>
        üîã <span class="dato">${bateriaFinal.toFixed(1)}% bater√≠a final</span><br>
        üóì <span class="dato">${diasCubiertos} d√≠as con esta carga</span><br>
        üí∂ <span class="dato">${coste.toFixed(2)} ‚Ç¨</span><br>
        üìâ <span class="dato">${costeKm.toFixed(3)} ‚Ç¨/km</span><br>
        üìä <span class="dato">${coste100.toFixed(2)} ‚Ç¨/100 km</span><br>
        üïí <span class="dato">${horaFin}</span>`;
}

function guardar() {
    if (!ultimaCarga) return;
    const data = JSON.parse(localStorage.getItem("cargas") || "[]");
    data.push({
        fecha: new Date().toISOString(),
        energia: ultimaCarga.energia,
        coste: ultimaCarga.coste,
        km: ultimaCarga.km,
        bateriaFinal: ultimaCarga.bateriaFinal
    });
    localStorage.setItem("cargas", JSON.stringify(data));
    mostrar();
}

function mostrar() {
    const data = JSON.parse(localStorage.getItem("cargas") || "[]");
    const ahora = new Date();

    let totalCoste = 0;
    let totalKm = 0;

    const mes = data.filter(c => {
        const f = new Date(c.fecha);
        return f.getMonth() === ahora.getMonth() &&
               f.getFullYear() === ahora.getFullYear();
    });

    let html = "";
    let labels = [], kmData = [], costeData = [];

    mes.forEach(c => {
        totalCoste += c.coste;
        totalKm += c.km;
        const fecha = new Date(c.fecha).toLocaleDateString();
        html += `‚Ä¢ ${fecha} ‚Üí ${c.km.toFixed(1)} km / ${c.coste.toFixed(2)} ‚Ç¨<br>`;
        labels.push(fecha);
        kmData.push(c.km.toFixed(1));
        costeData.push(c.coste.toFixed(2));
    });

    const coste100 = totalKm ? (totalCoste / totalKm) * 100 : 0;
    html += `<br><b>Total mes:</b><br>
             üöó ${totalKm.toFixed(0)} km<br>
             üí∂ ${totalCoste.toFixed(2)} ‚Ç¨<br>
             üìä ${coste100.toFixed(2)} ‚Ç¨/100 km`;

    historial.innerHTML = html || "Sin registros";

    const ctx = document.getElementById('grafico').getContext('2d');
    if (window.grafico) window.grafico.destroy();
    window.grafico = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { label: 'Km', data: kmData, backgroundColor: '#007aff' },
                { label: '‚Ç¨', data: costeData, backgroundColor: '#34c759' }
            ]
        },
        options: { responsive:true, plugins: { legend: { position: 'top' } } }
    });
}

function borrar() {
    if (confirm("¬øBorrar todo el historial?")) {
        localStorage.removeItem("cargas");
        mostrar();
    }
}

function exportarCSV() {
    const data = JSON.parse(localStorage.getItem("cargas") || "[]");
    if (!data.length) { 
        alert("No hay datos para exportar"); 
        return; 
    }

    let csv = "Fecha,KWh,Coste (‚Ç¨),Km,Bateria final (%)\n";
    data.forEach(c => {
        csv += `${new Date(c.fecha).toLocaleString()},${c.energia.toFixed(2)},${c.coste.toFixed(2)},${c.km.toFixed(1)},${c.bateriaFinal.toFixed(1)}\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });

    if (navigator.msSaveBlob) { 
        navigator.msSaveBlob(blob, "historial_cargas.csv");
    } else {
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", "historial_cargas.csv");
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}

// Importaci√≥n CSV con detecci√≥n de duplicados
function importarCSV() {
    const input = document.getElementById('fileInput');
    if (!input.files.length) return alert("Selecciona un archivo CSV");

    const file = input.files[0];
    const reader = new FileReader();

    reader.onload = function(e) {
        const text = e.target.result;
        const lines = text.trim().split('\n');
        if (lines.length < 2) return alert("CSV vac√≠o o mal formateado");

        let data = JSON.parse(localStorage.getItem("cargas") || "[]");

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(',');
            if (row.length !== 5) continue;
            const [fecha, energia, coste, km, bateriaFinal] = row;

            const existe = data.some(c =>
                new Date(c.fecha).toISOString() === new Date(fecha).toISOString() &&
                Math.abs(c.energia - parseFloat(energia)) < 0.001
            );
            if (existe) continue;

            data.push({
                fecha: new Date(fecha).toISOString(),
                energia: parseFloat(energia),
                coste: parseFloat(coste),
                km: parseFloat(km),
                bateriaFinal: parseFloat(bateriaFinal)
            });
        }

        localStorage.setItem("cargas", JSON.stringify(data));
        mostrar();
        alert("CSV importado correctamente (duplicados ignorados)");
    };

    reader.readAsText(file);
}

mostrar();
</script>
</body>
</html>