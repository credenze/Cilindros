<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Carga C3 El√©ctrico - PWA</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Carga C3">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    margin:0;
    padding:20px;
    background:#f4f4f8;
}

h2 { text-align:center; margin-bottom:16px; }

.card {
    background:white;
    padding:20px;
    border-radius:12px;
    box-shadow:0 4px 10px rgba(0,0,0,0.1);
    margin-bottom:20px;
}

input, button {
    width:100%;
    font-size:18px;
    padding:10px;
    margin-top:10px;
    border-radius:8px;
    border:1px solid #ccc;
}

button {
    background:#007aff;
    color:white;
    border:none;
    margin-top:16px;
}

button:active { background:#005fcc; }

canvas {
    width:100%;
    height:320px;
    margin-top:20px;
    border:1px solid #ddd;
    border-radius:12px;
}

.note { font-size:0.85rem; color:#555; margin-top:10px; text-align:center; }

/* Tooltip */
#tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 6px 10px;
    border-radius:6px;
    pointer-events:none;
    font-size:12px;
    display:none;
    z-index:100;
    max-width: 120px;
    word-wrap: break-word;
}

table {
    width:100%;
    border-collapse:collapse;
    margin-top:20px;
    text-align:center;
    table-layout: fixed;
}

th, td { border:1px solid #ddd; padding:8px; font-size:14px;}
th { background:#eee;}
</style>
</head>

<body>

<h2>üîã Carga Citro√´n C3 El√©ctrico</h2>

<div class="card">
    <label>Bater√≠a actual (%)</label>
    <input type="number" id="porcentaje" value="30" min="0" max="100">

    <label>M√°x amperios a mostrar</label>
    <input type="number" id="amperiosMax" value="16" min="6" max="16">

    <button onclick="calcular()">Calcular evoluci√≥n</button>

    <canvas id="grafica"></canvas>
    <div id="horaFin" class="note"></div>
    <div id="tablaResultados"></div>
</div>

<div id="tooltip"></div>

<script>
const SUBIDA = {6:3, 10:5, 12:6, 16:8};
const HORAS_MAX = 16;
const colores = {6:"#007aff",10:"#00b300",12:"#ff6600",16:"#ff0000"};

function calcular() {
    const porcentaje = Number(document.getElementById("porcentaje").value);
    const amperiosMax = Number(document.getElementById("amperiosMax").value);
    if(isNaN(porcentaje) || porcentaje<0 || porcentaje>100) { alert("0-100"); return; }
    if(isNaN(amperiosMax) || amperiosMax<6 || amperiosMax>16) { alert("6-16 A"); return; }

    const amperios = [6,10,12,16].filter(a=>a<=amperiosMax);
    const ahora = new Date();

    const canvas = document.getElementById("grafica");
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;
    const ctx = canvas.getContext("2d");

    ctx.clearRect(0,0,canvas.width,canvas.height);

    // Ejes
    ctx.strokeStyle="#aaa"; ctx.lineWidth=1;
    ctx.beginPath();
    ctx.moveTo(50,10); ctx.lineTo(50,canvas.height-60);
    ctx.lineTo(canvas.width-10,canvas.height-60);
    ctx.stroke();

    // L√≠neas gu√≠a y % Y
    ctx.fillStyle="#555"; ctx.font="12px sans-serif";
    for(let i=0;i<=5;i++){
        const y = canvas.height-60 - i*(canvas.height-50)/5;
        ctx.fillText((i*20)+"%",0,y+5);
        ctx.beginPath();
        ctx.moveTo(50,y); ctx.lineTo(canvas.width-10,y);
        ctx.strokeStyle="#eee";
        ctx.stroke();
    }

    // Dibujar horas fijas en X
    ctx.fillStyle="#555";
    ctx.font="10px sans-serif";
    for(let h=0;h<=HORAS_MAX;h++){
        const horaActual = new Date(ahora); horaActual.setHours(horaActual.getHours()+h);
        const x = 50 + h*(canvas.width-60)/HORAS_MAX;
        ctx.fillText(horaActual.getHours().toString().padStart(2,'0')+":00",x-12,canvas.height-45);
    }

    // Guardar puntos para tooltip
    const puntos = [];

    for(let a of amperios){
        ctx.beginPath(); ctx.strokeStyle = colores[a]; ctx.lineWidth=2;

        for(let h=0;h<=HORAS_MAX;h++){
            const horaActual = new Date(ahora); horaActual.setHours(horaActual.getHours()+h);
            const x = 50 + h*(canvas.width-60)/HORAS_MAX;
            const y = canvas.height-60 - Math.min(porcentaje+h*SUBIDA[a],100)*(canvas.height-50)/100;

            if(h===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);

            puntos.push({x,y,hora:horaActual.getHours().toString().padStart(2,'0')+":00", valor:Math.min(porcentaje+h*SUBIDA[a],100).toFixed(1), amper:a});
        }
        ctx.stroke();

        // Puntos visibles
        for(let h=0;h<=HORAS_MAX;h++){
            const p = puntos.find(pt=>pt.amper===a && pt.hora===new Date(ahora).setHours(new Date(ahora).getHours()+h));
            const x = 50 + h*(canvas.width-60)/HORAS_MAX;
            const y = canvas.height-60 - Math.min(porcentaje+h*SUBIDA[a],100)*(canvas.height-50)/100;
            ctx.beginPath(); ctx.arc(x,y,5,0,2*Math.PI); ctx.fillStyle=colores[a]; ctx.fill();
            ctx.strokeStyle="#fff"; ctx.lineWidth=1; ctx.stroke();
        }
    }

    // Tooltip t√°ctil y mouse
    const tooltip = document.getElementById("tooltip");

    function showTooltip(e) {
        const rect = canvas.getBoundingClientRect();
        let mx, my;
        if(e.touches) { mx=e.touches[0].clientX-rect.left; my=e.touches[0].clientY-rect.top; }
        else { mx=e.offsetX; my=e.offsetY; }

        let show=false;
        for(let p of puntos){
            if(Math.hypot(mx-p.x,my-p.y)<8){
                let left = p.x+rect.left+10;
                let top = p.y+rect.top-35;
                if(top<10) top=10;
                tooltip.style.left=left+"px";
                tooltip.style.top=top+"px";
                tooltip.innerHTML=`${p.amper} A: ${p.valor}% a las ${p.hora}`;
                tooltip.style.display="block";
                show=true;
                break;
            }
        }
        if(!show) tooltip.style.display="none";
    }

    canvas.onmousemove=showTooltip;
    canvas.ontouchstart=showTooltip;
    canvas.ontouchmove=showTooltip;
    canvas.ontouchend=()=>tooltip.style.display="none";

    // Hora aprox 100% amperaje m√°ximo
    const maxA = Math.max(...amperios);
    const horasPara100 = Math.ceil((100-porcentaje)/SUBIDA[maxA]);
    const horaFin = new Date(ahora);
    horaFin.setHours(horaFin.getHours() + horasPara100);
    document.getElementById("horaFin").textContent = `Hora aprox. 100% (${maxA} A): ${horaFin.toLocaleTimeString("es-ES",{hour:'2-digit',minute:'2-digit'})}`;

    // Tabla con table-layout fixed
    let tablaHTML=`<table><tr><th>Hora</th>${amperios.map(a=>"<th>"+a+"A</th>").join("")}</tr>`;
    for(let h=0;h<=HORAS_MAX;h++){
        const horaActual = new Date(ahora); horaActual.setHours(horaActual.getHours()+h);
        tablaHTML+="<tr><td>"+horaActual.getHours().toString().padStart(2,'0')+":00</td>";
        for(let a of amperios){
            tablaHTML+="<td>"+Math.min(porcentaje+h*SUBIDA[a],100).toFixed(1)+"%</td>";
        }
        tablaHTML+="</tr>";
    }
    tablaHTML+="</table>";
    document.getElementById("tablaResultados").innerHTML = tablaHTML;
}
</script>
</body>
</html>